{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
  <div>
    <div class="text-secondary small">{{ t('stats.for') }}</div>
    <h1 class="h4 mb-0">{{ active_collection.name }}</h1>
    <div class="small text-secondary">{{ t('stats.role') }}: {{ t('role.' ~ active_role) }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/">{{ t('stats.back_to_records') }}</a>
  </div>
</div>

{# --- KPI cards --- #}
<div class="row g-3 mb-3">
  <div class="col-12 col-md-4 col-xl-2">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">{{ t('stats.kpi.total') }}</div>
        <div class="display-6 mb-0">{{ total }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 col-xl-2">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">{{ t('stats.kpi.artists') }}</div>
        <div class="display-6 mb-0">{{ unique_artists }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 col-xl-2">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">{{ t('stats.kpi.labels') }}</div>
        <div class="display-6 mb-0">{{ unique_labels }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 col-xl-2">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">{{ t('stats.kpi.years') }}</div>
        <div class="display-6 mb-0">{{ unique_years }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 col-xl-2">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">{{ t('stats.kpi.with_photos') }}</div>
        <div class="display-6 mb-0">{{ records_with_photos }}</div>
        <div class="small text-secondary">{{ records_no_photos }} {{ t('stats.kpi.without_photos') }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 col-xl-2">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">{{ t('stats.kpi.potential_duplicates') }}</div>
        <div class="display-6 mb-0">{{ dup_estimated }}</div>
        <div class="small text-secondary">{{ t('stats.kpi.duplicate_hint') }}</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">{{ t('stats.health.title') }}</h2>
          <span class="badge text-bg-secondary">{{ health_score }}/100</span>
        </div>

        <div class="mb-2">
          <div class="d-flex justify-content-between small">
            <span>{{ t('stats.health.year_filled') }}</span><span>{{ pct_year }}%</span>
          </div>
          <div class="progress" style="height: .5rem;">
            <div class="progress-bar" role="progressbar" style="width: {{ pct_year }}%"></div>
          </div>
        </div>

        <div class="mb-2">
          <div class="d-flex justify-content-between small">
            <span>{{ t('stats.health.barcode_filled') }}</span><span>{{ pct_barcode }}%</span>
          </div>
          <div class="progress" style="height: .5rem;">
            <div class="progress-bar" role="progressbar" style="width: {{ pct_barcode }}%"></div>
          </div>
        </div>

        <div class="mb-2">
          <div class="d-flex justify-content-between small">
            <span>{{ t('stats.health.discogs_linked') }}</span><span>{{ pct_discogs }}%</span>
          </div>
          <div class="progress" style="height: .5rem;">
            <div class="progress-bar" role="progressbar" style="width: {{ pct_discogs }}%"></div>
          </div>
        </div>

        <div class="mb-2">
          <div class="d-flex justify-content-between small">
            <span>{{ t('stats.health.records_with_photos') }}</span><span>{{ pct_photos }}%</span>
          </div>
          <div class="progress" style="height: .5rem;">
            <div class="progress-bar" role="progressbar" style="width: {{ pct_photos }}%"></div>
          </div>
        </div>

        <hr class="my-3"/>
        <div class="small text-secondary">
          {{ t('stats.health.suggestions') }}:
          <ul class="mb-0">
            {% if missing_year %}<li>{{ t('stats.health.missing_year', n=missing_year) }}</li>{% endif %}
            {% if missing_barcode %}<li>{{ t('stats.health.missing_barcode', n=missing_barcode) }}</li>{% endif %}
            {% if missing_discogs %}<li>{{ t('stats.health.missing_discogs', n=missing_discogs) }}</li>{% endif %}
            {% if records_no_photos %}<li>{{ t('stats.health.missing_photos', n=records_no_photos) }}</li>{% endif %}
            {% if not missing_year and not missing_barcode and not missing_discogs and not records_no_photos %}
              <li>{{ t('stats.health.nothing_to_fix') }}</li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="accordion" id="topAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="topArtistsHead">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#topArtists" aria-expanded="true" aria-controls="topArtists">
                {{ t('stats.top_artists') }} ({{ top_artists|length }})
              </button>
            </h2>
            <div id="topArtists" class="accordion-collapse collapse show" aria-labelledby="topArtistsHead" data-bs-parent="#topAccordion">
              <div class="accordion-body">
                {% if top_artists|length == 0 %}
                  <div class="text-secondary">{{ t('stats.no_artist_data') }}</div>
                {% else %}
                  <div class="list-group list-group-flush">
                    {% for a in top_artists %}
                      <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span class="text-truncate me-3">{{ a.name }}</span>
                        <span class="badge text-bg-secondary">{{ a.cnt }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="topLabelsHead">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#topLabels" aria-expanded="false" aria-controls="topLabels">
                {{ t('stats.top_labels') }} ({{ top_labels|length }})
              </button>
            </h2>
            <div id="topLabels" class="accordion-collapse collapse" aria-labelledby="topLabelsHead" data-bs-parent="#topAccordion">
              <div class="accordion-body">
                {% if top_labels|length == 0 %}
                  <div class="text-secondary">{{ t('stats.no_label_data') }}</div>
                {% else %}
                  <div class="list-group list-group-flush">
                    {% for a in top_labels %}
                      <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span class="text-truncate me-3">{{ a.name }}</span>
                        <span class="badge text-bg-secondary">{{ a.cnt }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6 mb-3">{{ t('stats.year_distribution') }}</h2>
        {% if by_year|length == 0 %}
          <div class="text-secondary">{{ t('stats.no_year_data') }}</div>
        {% else %}
          <div class="row g-2">
            {% for y in by_year %}
              <div class="col-6 col-md-3 col-xl-2">
                <div class="border rounded p-2 h-100">
                  <div class="small text-secondary">{{ y.year }}</div>
                  <div class="fw-semibold">{{ y.cnt }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# --- Duplicate Explorer --- #}
<div class="row g-3">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <h2 class="h6 mb-0">{{ t('stats.duplicates_explorer') }}</h2>
          <div class="small text-secondary">{{ t('stats.duplicates_desc') }}</div>
        </div>

        <div class="accordion mt-3" id="dupAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="dupHeadRelease">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#dupRelease" aria-expanded="true" aria-controls="dupRelease">
                {{ t('stats.dup.by_release') }} ({{ dup_release_groups|length }})
              </button>
            </h2>
            <div id="dupRelease" class="accordion-collapse collapse show" aria-labelledby="dupHeadRelease" data-bs-parent="#dupAccordion">
              <div class="accordion-body">
                {% if dup_release_groups|length == 0 %}
                  <div class="text-secondary">{{ t('stats.dup.none_release') }}</div>
                {% else %}
                  {% for g in dup_release_groups %}
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-semibold">{{ t('stats.dup.release_prefix') }} #{{ g.key }}</div>
                        <span class="badge text-bg-secondary">{{ g.cnt }}</span>
                      </div>
                      <div class="list-group mt-2">
                        {% for r in g.records %}
                          <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="/records/{{ r.id }}">
                            {% if r.cover_url %}
                              <img src="{{ r.cover_url }}" alt="" style="width:48px;height:48px;object-fit:cover;" class="rounded shadow-sm">
                            {% else %}
                              <div style="width:48px;height:48px;" class="rounded bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center small text-secondary">—</div>
                            {% endif %}
                            <div class="min-w-0">
                              <div class="text-truncate">{{ r.artist or t('common.unknown_artist') }} — {{ r.title or t('common.untitled') }}</div>
                              <div class="small text-secondary">{{ r.year or "" }}</div>
                            </div>
                          </a>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="dupHeadBarcode">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dupBarcode" aria-expanded="false" aria-controls="dupBarcode">
                {{ t('stats.dup.by_barcode') }} ({{ dup_barcode_groups|length }})
              </button>
            </h2>
            <div id="dupBarcode" class="accordion-collapse collapse" aria-labelledby="dupHeadBarcode" data-bs-parent="#dupAccordion">
              <div class="accordion-body">
                {% if dup_barcode_groups|length == 0 %}
                  <div class="text-secondary">{{ t('stats.dup.none_barcode') }}</div>
                {% else %}
                  {% for g in dup_barcode_groups %}
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-semibold">{{ g.key }}</div>
                        <span class="badge text-bg-secondary">{{ g.cnt }}</span>
                      </div>
                      <div class="list-group mt-2">
                        {% for r in g.records %}
                          <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="/records/{{ r.id }}">
                            {% if r.cover_url %}
                              <img src="{{ r.cover_url }}" alt="" style="width:48px;height:48px;object-fit:cover;" class="rounded shadow-sm">
                            {% else %}
                              <div style="width:48px;height:48px;" class="rounded bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center small text-secondary">—</div>
                            {% endif %}
                            <div class="min-w-0">
                              <div class="text-truncate">{{ r.artist or t('common.unknown_artist') }} — {{ r.title or t('common.untitled') }}</div>
                              <div class="small text-secondary">{{ r.year or "" }}</div>
                            </div>
                          </a>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="dupHeadSig">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dupSig" aria-expanded="false" aria-controls="dupSig">
                {{ t('stats.dup.by_sig') }} ({{ dup_sig_groups|length }})
              </button>
            </h2>
            <div id="dupSig" class="accordion-collapse collapse" aria-labelledby="dupHeadSig" data-bs-parent="#dupAccordion">
              <div class="accordion-body">
                {% if dup_sig_groups|length == 0 %}
                  <div class="text-secondary">{{ t('stats.dup.none_sig') }}</div>
                {% else %}
                  {% for g in dup_sig_groups %}
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-semibold text-truncate me-3">{{ g.label }}</div>
                        <span class="badge text-bg-secondary">{{ g.cnt }}</span>
                      </div>
                      <div class="list-group mt-2">
                        {% for r in g.records %}
                          <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="/records/{{ r.id }}">
                            {% if r.cover_url %}
                              <img src="{{ r.cover_url }}" alt="" style="width:48px;height:48px;object-fit:cover;" class="rounded shadow-sm">
                            {% else %}
                              <div style="width:48px;height:48px;" class="rounded bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center small text-secondary">—</div>
                            {% endif %}
                            <div class="min-w-0">
                              <div class="text-truncate">{{ r.artist or t('common.unknown_artist') }} — {{ r.title or t('common.untitled') }}</div>
                              <div class="small text-secondary">{{ r.year or "" }}</div>
                            </div>
                          </a>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
