<!doctype html>
<html lang="{{ lang|default('en') }}" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ app_name }}{% if title %} · {{ title }}{% endif %}</title>

  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg?v=2">
  <!--  <link rel="icon" href="/static/img/favicon.svg?v=1" sizes="any"> -->

  <script>
  (function () {
    try {
      const key = 'vinylcat_theme';
      const THEMES = {
        // dark
        darkly: { bootswatch: 'darkly', mode: 'dark' },
        cyborg: { bootswatch: 'cyborg', mode: 'dark' },
        slate: { bootswatch: 'slate', mode: 'dark' },
        superhero: { bootswatch: 'superhero', mode: 'dark' },
        vapor: { bootswatch: 'vapor', mode: 'dark' },

        // light
        flatly: { bootswatch: 'flatly', mode: 'light' },
        lumen: { bootswatch: 'lumen', mode: 'light' },
        minty: { bootswatch: 'minty', mode: 'light' },
        sandstone: { bootswatch: 'sandstone', mode: 'light' },

        // custom hybrid
        'lumen-dark': { bootswatch: 'lumen', mode: 'dark', extra: '/static/css/lumen-dark.css' },
      };

      const saved = localStorage.getItem(key);
      const name = (saved && THEMES[saved]) ? saved : 'lumen';
      const cfg = THEMES[name];

      // set attributes early to avoid flash
      const html = document.documentElement;
      html.dataset.themeName = name;
      html.setAttribute('data-bs-theme', cfg.mode);

      // set CSS hrefs early (must happen before browser downloads default CSS)
      const themeLink = document.getElementById('theme-css');
      if (themeLink) {
        themeLink.href = `https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/${cfg.bootswatch}/bootstrap.min.css`;
      }

      const extraLink = document.getElementById('theme-extra-css');
      if (extraLink) {
        extraLink.href = cfg.extra || '';
      }
    } catch (e) {
      // ignore
    }
  })();
  </script>

  <!-- Google Consent Mode (default: denied until user choice) -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    // Default to denied until user decides
    gtag('consent', 'default', {
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied'
    });
  </script>

  <!-- Bootswatch theme (swapped by JS) -->
  <link id="theme-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lumen/bootstrap.min.css">
  <link id="theme-extra-css" rel="stylesheet" href="">
  <link rel="stylesheet" href="/static/css/app.css">

  <style>
    /* Brand logo visibility across light/dark themes without needing a second SVG */
    .brand-logo {
      height: 28px;
      width: auto;
      display: block;
    }
    /* In dark themes, lightly invert/boost the logo so black text/icon doesn't disappear */
    [data-bs-theme="dark"] .brand-logo {
      filter: invert(1) hue-rotate(180deg) contrast(1.1) brightness(1.1);
    }
    /* Keep it crisp and aligned */
    .navbar-brand {
      line-height: 1;
    }

    /* Cookie banner */
    #cookie-banner {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      max-width: 980px;
      margin: 0 auto;
      background: var(--bs-body-bg);
      color: var(--bs-body-color);
      border: 1px solid var(--bs-border-color);
      padding: 14px 16px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
      display: none;
      z-index: 9999;
    }
    #cookie-banner .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items: center;
    }
  </style>
</head>

<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold d-flex align-items-center gap-2" href="/">
      <img class="brand-logo" src="/static/img/vinylcat-logo.svg" alt="VinylCat">
      <span class="d-none d-sm-inline">{{ app_name }}</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        {% if user %}
        <li class="nav-item"><a class="nav-link" href="/">{{ t("nav.records") }}</a></li>
        <li class="nav-item"><a class="nav-link" href="/stats">{{ t("nav.stats") }}</a></li>
        <li class="nav-item"><a class="nav-link" href="/collections">{{ t("nav.collections") }}</a></li>
        <li class="nav-item"><a class="nav-link" href="/account">{{ t("nav.account") }}</a></li>
        {% endif %}
      </ul>

      <div class="d-flex align-items-center gap-2">
        <div class="form-check form-switch m-0 d-flex align-items-center gap-2" title="{{ t('ui.covers') }}">
          <input class="form-check-input" type="checkbox" role="switch" id="toggle-covers">
          <label class="form-check-label small text-secondary" for="toggle-covers">{{ t("ui.covers") }}</label>
        </div>

        <div class="form-check form-switch m-0 d-flex align-items-center gap-2" title="{{ t('ui.contrast') }}">
          <input class="form-check-input" type="checkbox" role="switch" id="toggle-contrast">
          <label class="form-check-label small text-secondary" for="toggle-contrast">{{ t("ui.contrast") }}</label>
        </div>

        
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            {{ lang|upper }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end" style="min-width: 12rem;">
            <li><h6 class="dropdown-header">{{ t("lang.select") }}</h6></li>
            {% for opt in language_options %}
              <li>
                <a class="dropdown-item {% if opt.code == lang %}active{% endif %}" href="/lang/{{ opt.code }}">
                  {{ opt.label }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>

<div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">{{ t("ui.theme") }}</button>
          <ul class="dropdown-menu dropdown-menu-end" style="min-width: 14rem;">
            <li><h6 class="dropdown-header">{{ t("ui.dark") }}</h6></li>
            <li><a class="dropdown-item theme-item" data-theme="darkly" href="#">{{ t("theme.darkly") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="cyborg" href="#">{{ t("theme.cyborg") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="slate" href="#">{{ t("theme.slate") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="superhero" href="#">{{ t("theme.superhero") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="vapor" href="#">{{ t("theme.vapor") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="lumen-dark" href="#">{{ t("theme.lumen_dark") }}</a></li>
            <li><hr class="dropdown-divider"/></li>
            <li><h6 class="dropdown-header">{{ t("ui.light") }}</h6></li>
            <li><a class="dropdown-item theme-item" data-theme="flatly" href="#">{{ t("theme.flatly") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="lumen" href="#">{{ t("theme.lumen") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="minty" href="#">{{ t("theme.minty") }}</a></li>
            <li><a class="dropdown-item theme-item" data-theme="sandstone" href="#">{{ t("theme.sandstone") }}</a></li>
          </ul>
        </div>

        {% if user %}
          <span class="text-secondary small d-none d-md-inline">
            {{ t("auth.signed_in_as") }} <span class="text-body">{{ user.email }}</span>
          </span>
          <a class="btn btn-outline-secondary btn-sm" href="/logout">{{ t("auth.logout") }}</a>
        {% else %}
          <a class="btn btn-outline-secondary btn-sm" href="/login">{{ t("auth.login") }}</a>
        {% endif %}
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">
  {% if info %}
    <div class="alert alert-info">{{ info }}</div>
  {% endif %}
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}
  {% block content %}{% endblock %}

  <!-- Simple footer links (optional, but handy for compliance) -->
  <div class="mt-4 pt-3 border-top small text-secondary d-flex flex-wrap gap-3 align-items-center">
    <a class="link-secondary" href="/privacy">{{ t("footer.privacy") }}</a>
    <a class="link-secondary" href="#" id="cookie-preferences-link">{{ t("cookie.settings") }}</a>
  </div>
</main>

<!-- Cookie banner -->
<div id="cookie-banner" role="dialog" aria-live="polite" aria-label="Cookie consent">
  <div class="small">
    {{ t("cookie.banner", app_name=app_name) | safe }}
    <a href="/privacy" class="link-secondary">{{ t("cookie.learn_more") }}</a>.
  </div>
  <div class="actions">
    <button class="btn btn-sm btn-primary" id="cookie-accept">{{ t("cookie.accept_analytics") }}</button>
    <button class="btn btn-sm btn-outline-secondary" id="cookie-reject">{{ t("cookie.reject") }}</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/theme.js"></script>
<script src="/static/js/ui_prefs.js"></script>

<script>
  // --- Google Analytics + Consent handling ---
  const GA_ID = "G-ZQD6R9PZV7";
  const CONSENT_KEY = "vinylcat_cookie_consent_v1"; // localStorage key

  function loadGA() {
    if (window.__ga_loaded) return;
    window.__ga_loaded = true;

    const s = document.createElement("script");
    s.async = true;
    s.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);
    document.head.appendChild(s);

    // Configure GA (privacy-minimizing options)
    gtag('js', new Date());
    gtag('config', GA_ID, {
      send_page_view: true,
      allow_google_signals: false,
      allow_ad_personalization_signals: false
    });
  }

  function setConsent(accepted) {
    const v = accepted ? "granted" : "denied";

    // Update consent mode
    gtag('consent', 'update', {
      analytics_storage: v,
      ad_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied'
    });

    localStorage.setItem(CONSENT_KEY, accepted ? "accepted" : "rejected");

    // Only load GA if accepted
    if (accepted) loadGA();

    hideCookieBanner();
  }

  function showCookieBanner(force) {
    const banner = document.getElementById("cookie-banner");
    if (!banner) return;

    if (force) {
      banner.style.display = "block";
      return;
    }

    const saved = localStorage.getItem(CONSENT_KEY);
    if (saved === "accepted") {
      // keep consent granted and load GA
      setConsent(true);
      return;
    }
    if (saved === "rejected") {
      // keep denied; do not load GA
      setConsent(false);
      return;
    }

    // No decision yet -> show banner
    banner.style.display = "block";
  }

  function hideCookieBanner() {
    const banner = document.getElementById("cookie-banner");
    if (banner) banner.style.display = "none";
  }

  document.addEventListener("DOMContentLoaded", () => {
    const acceptBtn = document.getElementById("cookie-accept");
    const rejectBtn = document.getElementById("cookie-reject");
    const prefsLink = document.getElementById("cookie-preferences-link");

    if (acceptBtn) acceptBtn.addEventListener("click", () => setConsent(true));
    if (rejectBtn) rejectBtn.addEventListener("click", () => setConsent(false));

    // “Change cookie preferences” link: show the banner again
    if (prefsLink) {
      prefsLink.addEventListener("click", (e) => {
        e.preventDefault();
        showCookieBanner(true); // force show, even if previously decided
      });
    }

    // initial load: show if needed / apply saved decision
    showCookieBanner(false);
  });
</script>

{% block scripts %}{% endblock %}
<a
  href="https://www.buymeacoffee.com/lukaszbartp"
  target="_blank"
  rel="noopener noreferrer"
  class="vinylcat-bmc-fab">
  ☕ <span class="d-none d-sm-inline">{{ t("bmc.buy_me_a_coffee") }}</span>
</a>

</body>
</html>
