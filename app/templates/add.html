{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <div class="text-secondary small">Add record to</div>
    <h1 class="h4 mb-0">{{ active_collection.name }}</h1>
  </div>
  <a class="btn btn-outline-secondary" href="/">Back</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" id="manualModeSwitch">
        <label class="form-check-label" for="manualModeSwitch">Manual entry mode</label>
      </div>
      <div class="text-secondary small">
        <span id="modeHintDiscogs">Using Discogs search (default)</span>
        <span id="modeHintManual" class="d-none">Adding a record manually</span>
      </div>
    </div>
    {% if not discogs_token_present %}
      <div class="alert alert-warning mb-3">
        No Discogs token is set in your account. Manual mode is enabled by default.
        You can add a Discogs token in <a href="/account">Account</a>.
      </div>
    {% endif %}

    <div class="row g-3">
      <!-- Always available: OCR / image analysis -->
      <div class="col-12 col-lg-6" id="imageSection">
        <h2 class="h6">1) Optional: upload cover images to auto-detect</h2>
        <div class="row g-2">
          <div class="col-12 col-md-6">
            <label class="form-label">Front cover (optional)</label>
            <input class="form-control" type="file" id="frontFile" accept="image/*">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Back cover (optional)</label>
            <input class="form-control" type="file" id="backFile" accept="image/*">
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 mt-2">
          <button class="btn btn-outline-secondary btn-sm" id="analyzeBtn" type="button">Analyze images</button>
          <span class="text-secondary small" id="analyzeStatus"></span>
        </div>
        <div class="small text-secondary mt-2">
          This tries to read <b>barcode</b> and extract possible <b>artist/title/year</b>. Works best with a clear back cover barcode.
        </div>
      </div>

      <!-- Discogs search OR manual entry (toggled) -->
      <div class="col-12 col-lg-6">
        <div id="discogsSection">
          <h2 class="h6">2) Search Discogs</h2>
          <form class="vstack gap-2" method="post" action="/records/search" id="searchForm">
            <div class="row g-2">
              <div class="col-12 col-md-4">
                <label class="form-label">Barcode</label>
                <input class="form-control" name="barcode" id="barcode" placeholder="UPC/EAN">
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Year</label>
                <input class="form-control" name="year" id="year" placeholder="e.g. 1998">
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Country</label>
                <input class="form-control" name="country" id="country" placeholder="e.g. Netherlands / US">
              </div>
            </div>
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label class="form-label">Artist</label>
                <input class="form-control" name="artist" id="artist" placeholder="e.g. Daft Punk">
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Title</label>
                <input class="form-control" name="title" id="title" placeholder="e.g. Homework">
              </div>
            </div>

            <button class="btn btn-primary mt-2" type="submit">Search</button>
          </form>
        </div>

        <div id="manualSection" class="d-none">
          <h2 class="h6">2) Add record manually</h2>
          <form class="vstack gap-2" method="post" action="/records/add_manual" id="manualForm">
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label class="form-label">Artist <span class="text-danger">*</span></label>
                <input class="form-control" name="artist" id="m_artist" required placeholder="e.g. Daft Punk">
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Title <span class="text-danger">*</span></label>
                <input class="form-control" name="title" id="m_title" required placeholder="e.g. Homework">
              </div>
            </div>
            <div class="row g-2">
              <div class="col-12 col-md-4">
                <label class="form-label">Year</label>
                <input class="form-control" name="year" id="m_year" inputmode="numeric" placeholder="e.g. 1998">
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Barcode</label>
                <input class="form-control" name="barcode" id="m_barcode" placeholder="UPC/EAN">
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Notes</label>
                <input class="form-control" name="notes" id="m_notes" placeholder="Optional">
              </div>
            </div>

            <div class="mt-2">
              <div class="d-flex align-items-center justify-content-between">
                <label class="form-label mb-1">Tracklist</label>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="addTrackRowBtn">Add track</button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-1" id="trackTable">
                  <thead>
                    <tr>
                      <th style="min-width: 260px">Title</th>
                      <th style="width: 120px">Duration</th>
                      <th style="width: 1%"></th>
                    </tr>
                  </thead>
                  <tbody id="trackTableBody">
                    <tr>
                      <td><input class="form-control form-control-sm" type="text" placeholder="Track title"></td>
                      <td><input class="form-control form-control-sm" type="text" placeholder="mm:ss"></td>
                      <td class="text-end"><button class="btn btn-outline-danger btn-sm" type="button" data-action="remove-track">&times;</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="small text-secondary">
                Tip: duration is optional (e.g. <code>3:45</code>). Leave empty if unknown.
              </div>
            </div>

            <!-- backend expects newline text; JS composes it from the table -->
            <input type="hidden" name="tracklist_text" id="tracklist_text">

            <button class="btn btn-success mt-2" type="submit">Add</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/add_analyze.js"></script>
<script>window.__DISCOGS_TOKEN_PRESENT={{ 1 if discogs_token_present else 0 }};</script>
<script src="/static/js/add_mode_toggle.js"></script>
<script src="/static/js/manual_tracks.js"></script>
{% endblock %}
